pipeline {
    agent any

    environment {
        email_recipients = "nilesh.rajput.snaatak@mygurukulam.co"
        slack_channel = "#project-notification"
        slack_webhook_creds_id = "neelesh-slack-webhook"
        branch_name = 'main'
        repo_url = 'https://github.com/OT-MICROSERVICES/attendance-api.git'
    }

    stages {
        stage('Clone Repository') {
            steps {
                git branch: branch_name, url: repo_url
            }
        }

        stage('Verify Commit Sign-Off') {
            steps {
                script {
                    def unsignedCommits = sh(script: '''
                        git log --pretty=format:"%h - %an: %s" --show-signature | grep -i -v "signed-off-by"
                    ''', returnStdout: true).trim()

                    if (unsignedCommits) {
                        error "The following commits are missing a sign-off:\n${unsignedCommits}"
                    }
                }
            }
        }
    }

    post {
        success {
            script {
                emailext(
                    subject: "Jenkins Build Successful [${env.BUILD_URL}]",
                    body: """Hello Team,

                    The Jenkins build has passed all checks, including commit sign-off verification.

                    Regards,
                    Jenkins
                    """,
                    attachLog: false,
                    to: email_recipients
                )

                slackSend(
                    channel: slack_channel,
                    message: "Build Success: ${currentBuild.fullDisplayName} \n Commit Sign-Off Verification Passed.",
                    color: 'good',
                    tokenCredentialId: slack_webhook_creds_id
                )
            }
        }

        failure {
            script {
                emailext(
                    subject: "Jenkins Build Failed - Commit Sign-Off Missing",
                    body: """Hello Team,

                    The Jenkins build has failed due to missing commit sign-offs.

                    Build Log URL: ${env.BUILD_URL}

                    Regards,
                    Jenkins
                    """,
                    attachLog: false,
                    to: email_recipients
                )

                slackSend(
                    channel: slack_channel,
                    message: "Build Failed: ${currentBuild.fullDisplayName} \n Commit Sign-Off Verification Failed.",
                    color: 'danger',
                    tokenCredentialId: slack_webhook_creds_id
                )
            }
        }
    }
}
