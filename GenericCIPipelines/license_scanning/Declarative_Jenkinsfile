pipeline {
    agent any

    environment {
        branch_name = 'main'
        repo_url = 'https://github.com/OT-MICROSERVICES/attendance-api.git'
        fossa_token_id = "neelesh-fossa-token"  // Jenkins Secret Text credential ID for FOSSA token
        email_recipients = "nilesh.rajput.snaatak@mygurukulam.co"
        fossa_report_name = "fossa-report.html" // Define the report name
    }

    stages {
        stage('Clean Workspace') {
            steps {
                cleanWs()
            }
        }

        stage('Clone Repository') {
            steps {
                script {
                    git url: repo_url, branch: branch_name
                }
            }
        }

        stage('Dependency Scanning (FOSSA)') {
            steps {
                script {
                    withCredentials([string(credentialsId: fossa_token_id, variable: 'FOSSA_API_KEY')]) {
                        sh """
                        export FOSSA_API_KEY=${FOSSA_API_KEY}
                        fossa init
                        fossa analyze
                        fossa report --format html attribution > ${fossa_report_name}
                        """
                }
                }
            }
        }

        stage('Publish FOSSA Report') {
            steps {
                archiveArtifacts artifacts: "${fossa_report_name}", fingerprint: true
            }
        }
    }

    post {
        always {
            script {
                def reportExists = fileExists(fossa_report_name)

                if (reportExists) {
                    def reportContent = readFile(fossa_report_name)

                    emailext(
                        subject: "FOSSA Dependency Scan Report (${repo_url}) - ${currentBuild.fullDisplayName}",
                        body: """Hello Team,

                        Please find attached the FOSSA dependency scan report for the repository ${repo_url}.

                        Build Log URL: ${BUILD_URL}console

                        Regards,
                        Jenkins
                        """,
                        attachLog: false,
                        attachmentsPattern: fossa_report_name,
                        to: email_recipients
                    )
                } else {
                    echo "FOSSA report not found. Skipping email notification."
                }
            }
        }

        failure {
            // Notify on failure
            emailext(
                subject: "FOSSA Dependency Scan Failed - ${currentBuild.fullDisplayName}",
                body: """Hello Team,

                The FOSSA dependency scan has failed for the build: ${currentBuild.fullDisplayName}.
                Build Log URL: ${BUILD_URL}console

                Please check the Jenkins logs for more details.

                Regards,
                Jenkins
                """,
                to: email_recipients
            )
        }
    }
}
 
