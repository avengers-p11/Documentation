node {
    // Define environment variables
    def branch_name = 'main'
    def repo_url = 'https://github.com/OT-MICROSERVICES/attendance-api.git'
    def fossa_token_id = "neelesh-fossa-token"
    def email_recipients = "nilesh.rajput.snaatak@mygurukulam.co"
    def fossa_report_name = "fossa-report.html"

    try {
        stage('Clean Workspace') {
            cleanWs()
        }

        stage('Clone Repository') {
            git url: repo_url, branch: branch_name
        }

        stage('Dependency Scanning (FOSSA)') {
            withCredentials([string(credentialsId: fossa_token_id, variable: 'FOSSA_API_KEY')]) {
                sh """
                export FOSSA_API_KEY=${FOSSA_API_KEY}
                fossa init
                fossa analyze
                fossa report --format html attribution > ${fossa_report_name}
                """
            }
        }

        stage('Publish FOSSA Report') {
            archiveArtifacts artifacts: "${fossa_report_name}", fingerprint: true
        }

    } catch (Exception e) {
        currentBuild.result = 'FAILURE'
        throw e
    } finally {
        // Post-build actions
        if (fileExists(fossa_report_name)) {
            // Send an email with the FOSSA report if it exists
            emailext(
                subject: "FOSSA Dependency Scan Report (${repo_url}) - ${currentBuild.fullDisplayName}",
                body: """Hello Team,

                Please find attached the FOSSA dependency scan report for the repository ${repo_url}.

                Build Log URL: ${BUILD_URL}console

                Regards,
                Jenkins
                """,
                attachLog: false,
                attachmentsPattern: fossa_report_name,
                to: email_recipients
            )
        } else {
            echo "FOSSA report not found. Skipping email notification."
        }

        // Failure email notification
        if (currentBuild.result == 'FAILURE') {
            emailext(
                subject: "FOSSA Dependency Scan Failed - ${currentBuild.fullDisplayName}",
                body: """Hello Team,

                The FOSSA dependency scan has failed for the build: ${currentBuild.fullDisplayName}.
                Build Log URL: ${BUILD_URL}console

                Please check the Jenkins logs for more details.

                Regards,
                Jenkins
                """,
                to: email_recipients
            )
        }
    }
}
