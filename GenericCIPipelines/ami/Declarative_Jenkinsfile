pipeline {
    agent any
    environment {
        aws_region = 'ap-south-1' // Replace with your AWS region
        packer_template = 'GenericCIPipelines/ami/packer_template.json' // Your Packer template file
        email_recipients = "nilesh.rajput.snaatak@mygurukulam.co"
        slack_channel = "#project-notification"
        slack_webhook_creds_id = "neelesh-slack-webhook"
        // branch_name = 'main'
        // repo_url = 'https://github.com/OT-MICROSERVICES/attendance-api.git'
    }
    stages {
        stage('Checkout Code') {
            steps {
                echo 'Checking out source code...'
                checkout scm
            }
        }
        stage('Validate Packer Template') {
            steps {
                echo 'Validating Packer template...'
                sh '''
                pwd && packer validate ${packer_template}
                '''
            }
        }
        stage('Build AMI') {
            steps {
                echo 'Building AMI via Packer...'
                sh '''
                packer build -var "aws_region=${aws_region}" ${packer_template}
                '''
            }
        }
    }
    post {
        success {
            script {
                emailext(
                    subject: "Jenkins AMI Build Successful [${env.BUILD_URL}]",
                    body: """Hello Team,

                    The Jenkins AMI build has passed.

                    Regards,
                    Jenkins
                    """,
                    attachLog: false,
                    to: email_recipients
                )

                slackSend(
                    channel: slack_channel,
                    message: "Build Success: ${currentBuild.fullDisplayName} \n Commit Sign-Off Verification Passed for repo ${repo_url}. \n Build URL: ${BUILD_URL}",
                    color: 'good',
                    tokenCredentialId: slack_webhook_creds_id
                )
            }
        }

        failure {
            script {
                emailext(
                    subject: "Jenkins AMI Build Failed",
                    body: """Hello Team,

                    The Jenkins AMI build has failed.

                    Build Log URL: ${env.BUILD_URL}

                    Regards,
                    Jenkins
                    """,
                    attachLog: false,
                    to: email_recipients
                )

                slackSend(
                    channel: slack_channel,
                    message: "Build Failed: ${currentBuild.fullDisplayName} \n AMI Build Failed \n Build URL: ${BUILD_URL}",
                    color: 'danger',
                    tokenCredentialId: slack_webhook_creds_id
                )
            }
        }
    }
}
