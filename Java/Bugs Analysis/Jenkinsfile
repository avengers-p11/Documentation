node {
    def mvnHome = tool name: 'Maven', type: 'maven'
    def sonarScannerHome = tool name: 'Sonar'

    env.PATH = "${mvnHome}/bin:${sonarScannerHome}/bin:${env.PATH}"

    stage('Clone Repository') {
        checkout([$class: 'GitSCM', 
                  branches: [[name: '*/main']], 
                  userRemoteConfigs: [[url: 'git@github.com:avengers-p11/salary-api.git']]])
    }

    stage('Code Compilation') {
        sh '''
            echo "Compiling the code..."
            mvn compile > compilation-report.txt
            ls -l compilation-report.txt  # Confirm file exists
            cat compilation-report.txt
        '''
    }

    stage('Bug Analysis') {
        echo "Running SonarQube Bug Analysis..."
        withSonarQubeEnv('Sonar') {  
            sh '''
                sonar-scanner \
                    -Dsonar.projectKey=salary \
                    -Dsonar.projectName=Salary-api \
                    -Dsonar.host.url=http://3.94.185.47:9000 \
                    -Dsonar.login=squ_4f371ade2db48dafec85157cda9d3d07e6a5c456 \
                    -Dsonar.java.binaries=target/classes \
                    -Dsonar.issue.types=BUG \
                    -Dsonar.report.export.path=target/sonar-report.json
            '''
        }
    }

    stage('Archive Report') {
        // Properly handle spaces in the path and archive reports
        archiveArtifacts artifacts: 'compilation-report.txt,target/sonar-report.json', allowEmptyArchive: true
        // List workspace directory content to confirm the path
        echo "Workspace: ${env.WORKSPACE}"  // Debugging the workspace path
        sh "ls -l \"${env.WORKSPACE}/Scripted_Java/Bug Analysis\""  
    }

    stage('Send Email') {
        def reportFiles = "compilation-report.txt,target/sonar-report.json"
        
        def reportFile = "${env.WORKSPACE}/compilation-report.txt"  
        def sonarReportFile = "${env.WORKSPACE}/target/sonar-report.json"

        if (fileExists(reportFile) && fileExists(sonarReportFile)) {
            if (currentBuild.result == null || currentBuild.result == 'SUCCESS') {
                emailext(
                    attachmentsPattern: reportFiles,  
                    body: """SUCCESS: Job ${env.JOB_NAME} build ${env.BUILD_NUMBER}
More info at: ${env.BUILD_URL}""",
                    recipientProviders: [developers(), requestor()],
                    subject: "Jenkins Build SUCCESS: Job ${env.JOB_NAME}",
                    to: 'it.mohitsaini@gmail.com'
                )
            } else {
                emailext(
                    to: 'it.mohitsaini@gmail.com',
                    subject: "Jenkins Pipeline Failure: ${env.JOB_NAME}",
                    body: '''Hello,

The Jenkins pipeline has failed. Please check the logs.'''.stripIndent()
                )
            }
        } else {
            echo "Error: Required report files not found. Email not sent."
        }
    }
}
