node {
    def VENV_DIR = "venv"

    try {
        stage('Clone Repository') {
            git branch: 'main', url: 'git@github.com:avengers-p11/attendance-api.git'
        }

        stage('Install Dependencies') {
            sh '''
                sudo apt-get update -y
                sudo apt-get install -y python3.11 python3.11-venv python3-pip
            '''
        }

        stage('Set Up Python Environment') {
            sh '''
                if [ ! -d "${VENV_DIR}" ]; then
                    python3.11 -m venv ${VENV_DIR}
                fi
                . ${VENV_DIR}/bin/activate
                pip install --upgrade pip poetry
            '''
        }

        stage('Install Project Dependencies') {
            sh '''
                . ${VENV_DIR}/bin/activate
                poetry install
            '''
        }

        stage('Run Tests') {
            sh '''
                . ${VENV_DIR}/bin/activate
                coverage run -m pytest
                coverage report > coverage.txt
            '''
        }
    } catch (Exception e) {
        mail(to: 'anjalidhiman.as@gmail.com', subject: 'Pipeline Failed', body: 'The pipeline has failed. Check logs for details.')
        throw e
    } finally {
        stage('Cleanup') {
            sh "rm -rf ${VENV_DIR}"
            archiveArtifacts artifacts: 'coverage.txt', allowEmptyArchive: true
        }
    }
}
