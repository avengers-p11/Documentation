node {
    def scannerHome = tool 'Sonar'

    try {
        stage('Clone Repository') {
            echo 'Cloning the repository...'
            git branch: 'main', url: 'git@github.com:avengers-p11/attendance-api.git'
        }

        stage('Static Code Analysis') {
            echo 'Running SonarQube analysis for static code analysis...'
            withSonarQubeEnv('Sonar') {
                sh """
                    ${scannerHome}/bin/sonar-scanner \
                        -Dsonar.projectKey=attendance \
                        -Dsonar.projectName=Attendance-api \
                        -Dsonar.host.url=http://3.85.16.100:9000 \
                        -Dsonar.login=squ_4f371ade2db48dafec85157cda9d3d07e6a5c456 \
                        -Dsonar.java.binaries=target/classes \
                        -Dsonar.sources=. \
                        -Dsonar.report.export.path=reports/static-code-analysis-report.txt
                """
            }
        }
    } catch (Exception e) {
        currentBuild.result = 'FAILURE'
        echo 'Pipeline failed.'
        emailext(
            to: 'anjalidhiman.as@gmail.com',
            subject: 'Jenkins Pipeline Failure: Attendance-api',
            body: """
                <html>
                    <body>
                        <h2>Pipeline Failure</h2>
                        <p>Hello,</p>
                        <p>The Jenkins pipeline has failed during static code analysis. Please check the logs for details.</p>
                    </body>
                </html>
            """,
            mimeType: 'text/html'
        )
        throw e
    } finally {
        stage('Post Actions') {
            echo 'Archiving artifacts...'
            script {
                def reportFile = 'reports/static-code-analysis-report.txt'
                if (fileExists(reportFile)) {
                    archiveArtifacts artifacts: reportFile, allowEmptyArchive: true
                } else {
                    echo "Report file not found: ${reportFile}"
                }
            }
            if (currentBuild.result == 'SUCCESS') {
                emailext(
                    attachmentsPattern: 'reports/static-code-analysis-report.txt',
                    to: 'anjalidhiman.as@gmail.com',
                    subject: "Jenkins Build SUCCESS: Attendance-api",
                    body: """
                        <html>
                            <body>
                                <h2>Build SUCCESS</h2>
                                <p>Job: ${env.JOB_NAME}</p>
                                <p>Build Number: ${env.BUILD_NUMBER}</p>
                                <p>Details: <a href="${env.BUILD_URL}">${env.BUILD_URL}</a></p>
                            </body>
                        </html>
                    """,
                    mimeType: 'text/html'
                )
            }
        }
    }
}
