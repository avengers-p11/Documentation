@Library('Jenkins-shared-libraries@main') _  

pipeline {
    agent any

    environment {
        VENV_DIR = "venv"
        TEST_REPORT_PATH = "test-reports/unit_test_report.xml"  
    }

    stages {
        stage('Clone Repository') {
            steps {
                script {
                    python_clone_repo()  
                }
            }
        }

        stage('Set Up Python Environment') {
            steps {
                script {
                    python_environment()  
                }
            }
        }

        stage('Poetry Lock') {
            steps {
                script {
                    poetry_lock()  
                }
            }
        }

        stage('Install Dependencies') {
            steps {
                script {
                    python_dependencies() 
                }
            }
        }

        stage('Unit Testing') {
            steps {
                script {
                    python_testing()  
                }
                junit 'test-reports/unit_test_report.xml'  
            }
        }

        stage('Send Test Report Email') {
            steps {
                script {
                    
                    emailext(
                        to: 'anjalidhiman.as@gmail.com',  
                        subject: "Unit Test Report - ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                        body: "Please find the attached unit test report for ${env.JOB_NAME} #${env.BUILD_NUMBER}.",
                        attachmentsPattern: TEST_REPORT_PATH,
                        mimeType: 'text/html'
                    )
                }
            }
        }
    }
}
