@Library('Jenkins-shared-libraries@main') _  // Replace with your library name

pipeline {
    agent any

    environment {
        VENV_DIR = "venv"
        TEST_REPORT_PATH = "test-reports/unit_test_report.xml"  // Path to your test report
    }

    stages {
        stage('Clone Repository') {
            steps {
                script {
                    python_clone_repo()  // Ensure this method is defined in your shared library
                }
            }
        }

        stage('Set Up Python Environment') {
            steps {
                script {
                    python_environment()  // Ensure this method is defined in your shared library
                }
            }
        }

        stage('Poetry Lock') {
            steps {
                script {
                    poetry_lock()  // Ensure this method is defined in your shared library
                }
            }
        }

        stage('Install Dependencies') {
            steps {
                script {
                    python_dependencies()  // Ensure this method is defined in your shared library
                }
            }
        }

        stage('Unit Testing') {
            steps {
                script {
                    python_testing()  // Ensure this method is defined in your shared library
                }
            }
        }

        stage('Send Test Report Email') {
            steps {
                script {
                    // Send email with the test report as an attachment
                    emailext(
                        to: 'it.mohitsaini@gmail.com',  // Replace with actual email address
                        subject: "Unit Test Report - ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                        body: "Please find the attached unit test report for ${env.JOB_NAME} #${env.BUILD_NUMBER}.",
                        attachmentsPattern: TEST_REPORT_PATH,
                        mimeType: 'text/html'
                    )
                }
            }
        }
    }
}
